name: anime-platform
services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
      POSTGRES_DB: app
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d app"]
      interval: 5s
      timeout: 3s
      retries: 20

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  nats:
    image: nats:2.10
    command: ["-js", "-m", "8222"]
    ports:
      - "4222:4222"
      - "8222:8222"

  meilisearch:
    image: getmeili/meilisearch:v1.7
    environment:
      MEILI_MASTER_KEY: dev-master-key
    ports:
      - "7700:7700"

  bff:
    build:
      context: .
      dockerfile: services/bff/Dockerfile
    environment:
      SERVICE_NAME: bff
      HTTP_ADDR: :8080
      LOG_LEVEL: debug
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      nats:
        condition: service_started

  auth:
    build:
      context: .
      dockerfile: services/auth/Dockerfile
    environment:
      SERVICE_NAME: auth
      HTTP_ADDR: :8081
      LOG_LEVEL: debug
    ports:
      - "8081:8081"
    depends_on:
      postgres:
        condition: service_healthy

  catalog:
    build:
      context: .
      dockerfile: services/catalog/Dockerfile
    environment:
      SERVICE_NAME: catalog
      HTTP_ADDR: :8082
      LOG_LEVEL: debug
    ports:
      - "8082:8082"
    depends_on:
      postgres:
        condition: service_healthy

  ingestion:
    build:
      context: .
      dockerfile: services/ingestion/Dockerfile
    environment:
      SERVICE_NAME: ingestion
      HTTP_ADDR: :8083
      LOG_LEVEL: debug
    ports:
      - "8083:8083"
    depends_on:
      nats:
        condition: service_started
      postgres:
        condition: service_healthy

  streaming:
    build:
      context: .
      dockerfile: services/streaming/Dockerfile
    environment:
      SERVICE_NAME: streaming
      HTTP_ADDR: :8084
      LOG_LEVEL: debug
    ports:
      - "8084:8084"
    depends_on:
      redis:
        condition: service_started

  activity:
    build:
      context: .
      dockerfile: services/activity/Dockerfile
    environment:
      SERVICE_NAME: activity
      HTTP_ADDR: :8085
      LOG_LEVEL: debug
    ports:
      - "8085:8085"
    depends_on:
      postgres:
        condition: service_healthy

  social:
    build:
      context: .
      dockerfile: services/social/Dockerfile
    environment:
      SERVICE_NAME: social
      HTTP_ADDR: :8086
      LOG_LEVEL: debug
    ports:
      - "8086:8086"
    depends_on:
      postgres:
        condition: service_healthy

  billing:
    build:
      context: .
      dockerfile: services/billing/Dockerfile
    environment:
      SERVICE_NAME: billing
      HTTP_ADDR: :8087
      LOG_LEVEL: debug
      STRIPE_WEBHOOK_SECRET: dev
      STRIPE_SECRET_KEY: dev
    ports:
      - "8087:8087"
    depends_on:
      postgres:
        condition: service_healthy
