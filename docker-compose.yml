name: anime-platform
services:
  redis:
    image: redis:7
    ports:
      - "6379:6379"

  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: app
    volumes:
      - ./deployments/postgres/init-multiple-dbs.sql:/docker-entrypoint-initdb.d/01-init-multiple-dbs.sql:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d app"]
      interval: 5s
      timeout: 3s
      retries: 20

  nats:
    image: nats:2.10
    command: ["-js", "-m", "8222"]
    ports:
      - "4222:4222"
      - "8222:8222"

  meilisearch:
    image: getmeili/meilisearch:v1.7
    environment:
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY}
    ports:
      - "7700:7700"

  search:
    build:
      context: .
      dockerfile: services/search/Dockerfile
    environment:
      SERVICE_NAME: search
      LOG_LEVEL: debug
      GRPC_ADDR: :9094
      CATALOG_GRPC_ADDR: catalog:9092
      NATS_URL: nats://nats:4222
      MEILI_URL: http://meilisearch:7700
      MEILI_API_KEY: ${MEILI_MASTER_KEY}
      REINDEX_INTERVAL: 24h
    ports:
      - "9094:9094"
    depends_on:
      catalog:
        condition: service_started
      nats:
        condition: service_started
      meilisearch:
        condition: service_started

  streaming-resolver:
    build:
      context: .
      dockerfile: services/streaming-resolver/Dockerfile
    environment:
      SERVICE_NAME: streaming-resolver
      LOG_LEVEL: debug
      GRPC_ADDR: :9095
      CATALOG_GRPC_ADDR: catalog:9092
      REDIS_URL: redis://redis:6379/0
      HIANIME_BASE_URL: https://void-roan-six.vercel.app/api/v2
      CACHE_TTL: 20m
      HIANIME_DEBUG: "true"
    ports:
      - "9095:9095"
    depends_on:
      catalog:
        condition: service_started
      redis:
        condition: service_started

  hls-proxy:
    build:
      context: .
      dockerfile: services/hls-proxy/Dockerfile
    environment:
      SERVICE_NAME: hls-proxy
      LOG_LEVEL: debug
      HTTP_ADDR: :8084
      HLS_SIGNING_SECRET: ${HLS_SIGNING_SECRET}
    ports:
      - "8084:8084"

  bff:
    build:
      context: .
      dockerfile: services/bff/Dockerfile
    environment:
      SERVICE_NAME: bff
      HTTP_ADDR: :8080
      LOG_LEVEL: debug
      JWT_SECRET: ${JWT_SECRET}
      AUTH_GRPC_ADDR: auth:9091
      CATALOG_GRPC_ADDR: catalog:9092
      ACTIVITY_GRPC_ADDR: activity:9093
      SEARCH_GRPC_ADDR: search:9094
      STREAMING_GRPC_ADDR: streaming-resolver:9095
      HLS_PROXY_BASE_URL: http://hls-proxy:8084
      HLS_SIGNING_SECRET: ${HLS_SIGNING_SECRET}
      NATS_URL: nats://nats:4222
      JIKAN_BASE_URL: https://api.jikan.moe/v4
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      nats:
        condition: service_started

  auth:
    build:
      context: .
      dockerfile: services/auth/Dockerfile
    environment:
      SERVICE_NAME: auth
      LOG_LEVEL: debug
      DATABASE_URL: postgres://app:${POSTGRES_PASSWORD}@postgres:5432/auth?sslmode=disable
      JWT_SECRET: ${JWT_SECRET}
      ACCESS_TOKEN_TTL: 15m
      REFRESH_TOKEN_TTL: 720h
      GRPC_ADDR: :9091
      BOOTSTRAP_ADMIN_USERNAME: admin
    ports:
      - "9091:9091"
    depends_on:
      postgres:
        condition: service_healthy

  catalog:
    build:
      context: .
      dockerfile: services/catalog/Dockerfile
    environment:
      SERVICE_NAME: catalog
      LOG_LEVEL: debug
      DATABASE_URL: postgres://app:${POSTGRES_PASSWORD}@postgres:5432/catalog?sslmode=disable
      GRPC_ADDR: :9092
      NATS_URL: nats://nats:4222
    ports:
      - "9092:9092"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_started

  ingestion:
    build:
      context: .
      dockerfile: services/ingestion/Dockerfile
    environment:
      SERVICE_NAME: ingestion
      HTTP_ADDR: :8083
      LOG_LEVEL: debug
      CATALOG_GRPC_ADDR: catalog:9092
      ANIMEKAI_BASE_URL: https://api.consumet.org/anime/animekai
      HIANIME_BASE_URL: https://void-roan-six.vercel.app/api/v2
      JIKAN_BASE_URL: https://api.jikan.moe/v4
      NATS_URL: nats://nats:4222
      JIKAN_RPS: 1
      HIANIME_RPS: 1
      ENABLE_HTTP_TRIGGERS: "false"
    ports:
      - "8083:8083"
    depends_on:
      catalog:
        condition: service_started
      postgres:
        condition: service_healthy

  streaming:
    build:
      context: .
      dockerfile: services/streaming/Dockerfile
    environment:
      SERVICE_NAME: streaming
      HTTP_ADDR: :8084
      LOG_LEVEL: debug
    ports:
      - "8085:8084"
    depends_on:
      redis:
        condition: service_started

  activity:
    build:
      context: .
      dockerfile: services/activity/Dockerfile
    environment:
      SERVICE_NAME: activity
      LOG_LEVEL: debug
      DATABASE_URL: postgres://app:${POSTGRES_PASSWORD}@postgres:5432/activity?sslmode=disable
      GRPC_ADDR: :9093
    ports:
      - "9093:9093"
    depends_on:
      postgres:
        condition: service_healthy

  social:
    build:
      context: .
      dockerfile: services/social/Dockerfile
    environment:
      SERVICE_NAME: social
      HTTP_ADDR: :8086
      LOG_LEVEL: debug
      DATABASE_URL: postgres://app:${POSTGRES_PASSWORD}@postgres:5432/social?sslmode=disable
    ports:
      - "8086:8086"
    depends_on:
      postgres:
        condition: service_healthy

  billing:
    build:
      context: .
      dockerfile: services/billing/Dockerfile
    environment:
      SERVICE_NAME: billing
      HTTP_ADDR: :8087
      LOG_LEVEL: debug
      STRIPE_WEBHOOK_SECRET: ${STRIPE_SECRET_KEY}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      DATABASE_URL: postgres://app:${POSTGRES_PASSWORD}@postgres:5432/billing?sslmode=disable
      REDIS_DSN: redis://redis:6379/1
      NATS_URL: nats://nats:4222
    ports:
      - "8087:8087"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      nats:
        condition: service_started
