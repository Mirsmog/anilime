name: anime-platform
services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
      POSTGRES_DB: app
    volumes:
      - ./deployments/postgres/init-multiple-dbs.sql:/docker-entrypoint-initdb.d/01-init-multiple-dbs.sql:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d app"]
      interval: 5s
      timeout: 3s
      retries: 20

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  nats:
    image: nats:2.10
    command: ["-js", "-m", "8222"]
    ports:
      - "4222:4222"
      - "8222:8222"

  meilisearch:
    image: getmeili/meilisearch:v1.7
    environment:
      MEILI_MASTER_KEY: dev-master-key
    ports:
      - "7700:7700"

  bff:
    build:
      context: .
      dockerfile: services/bff/Dockerfile
    environment:
      SERVICE_NAME: bff
      HTTP_ADDR: :8080
      LOG_LEVEL: debug
      JWT_SECRET: dev-secret-change-me
      AUTH_GRPC_ADDR: auth:9091
      CATALOG_GRPC_ADDR: catalog:9092
      ACTIVITY_GRPC_ADDR: activity:9093
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      nats:
        condition: service_started

  auth:
    build:
      context: .
      dockerfile: services/auth/Dockerfile
    environment:
      SERVICE_NAME: auth
      LOG_LEVEL: debug
      DATABASE_URL: postgres://app:app@postgres:5432/auth?sslmode=disable
      JWT_SECRET: dev-secret-change-me
      ACCESS_TOKEN_TTL: 15m
      REFRESH_TOKEN_TTL: 720h
      GRPC_ADDR: :9091
    ports:
      - "9091:9091"
    depends_on:
      postgres:
        condition: service_healthy

  catalog:
    build:
      context: .
      dockerfile: services/catalog/Dockerfile
    environment:
      SERVICE_NAME: catalog
      LOG_LEVEL: debug
      DATABASE_URL: postgres://app:app@postgres:5432/catalog?sslmode=disable
      GRPC_ADDR: :9092
    ports:
      - "9092:9092"
    depends_on:
      postgres:
        condition: service_healthy

  ingestion:
    build:
      context: .
      dockerfile: services/ingestion/Dockerfile
    environment:
      SERVICE_NAME: ingestion
      HTTP_ADDR: :8083
      LOG_LEVEL: debug
      CATALOG_GRPC_ADDR: catalog:9092
      ANIMEKAI_BASE_URL: https://api.consumet.org/anime/animekai
      HIANIME_BASE_URL: https://void-roan-six.vercel.app/api/v2
      JIKAN_BASE_URL: https://api.jikan.moe/v4
    ports:
      - "8083:8083"
    depends_on:
      catalog:
        condition: service_started
      postgres:
        condition: service_healthy

  streaming:
    build:
      context: .
      dockerfile: services/streaming/Dockerfile
    environment:
      SERVICE_NAME: streaming
      HTTP_ADDR: :8084
      LOG_LEVEL: debug
    ports:
      - "8084:8084"
    depends_on:
      redis:
        condition: service_started

  activity:
    build:
      context: .
      dockerfile: services/activity/Dockerfile
    environment:
      SERVICE_NAME: activity
      LOG_LEVEL: debug
      DATABASE_URL: postgres://app:app@postgres:5432/activity?sslmode=disable
      GRPC_ADDR: :9093
    ports:
      - "9093:9093"
    depends_on:
      postgres:
        condition: service_healthy

  social:
    build:
      context: .
      dockerfile: services/social/Dockerfile
    environment:
      SERVICE_NAME: social
      HTTP_ADDR: :8086
      LOG_LEVEL: debug
    ports:
      - "8086:8086"
    depends_on:
      postgres:
        condition: service_healthy

  billing:
    build:
      context: .
      dockerfile: services/billing/Dockerfile
    environment:
      SERVICE_NAME: billing
      HTTP_ADDR: :8087
      LOG_LEVEL: debug
      STRIPE_WEBHOOK_SECRET: dev
      STRIPE_SECRET_KEY: dev
    ports:
      - "8087:8087"
    depends_on:
      postgres:
        condition: service_healthy
